{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="flex min-h-screen">
  <main class="flex-1">
    <div class="flex flex-col">

      <!-- Mobile Header -->
      <header class="sticky top-0 z-10 flex items-center justify-between p-4 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm lg:hidden">
        <div class="flex items-center gap-3">
          <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-8" 
               style='background-image: url("{% static "images/default-profile.png" %}");'>
          </div>
          <h1 class="text-lg font-bold text-slate-900 dark:text-white">Quiz Hippo</h1>
        </div>
        <button class="lg:hidden p-2 rounded-lg hover:bg-slate-200/60 dark:hover:bg-slate-800/60">
          <span class="material-symbols-outlined">menu</span>
        </button>
      </header>

      <!-- Main Content -->
      <div class="p-4 sm:p-6 lg:p-8">
        <div class="max-w-4xl mx-auto">

          <!-- Page Title -->
          <div class="mb-8">
            <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Profile</h1>
            <p class="text-slate-600 dark:text-slate-400 mt-1">
              Manage your account and view quiz statistics.
            </p>
          </div>

          <!-- Profile Card -->
          <div class="flex flex-col sm:flex-row items-center gap-6 p-6 rounded-xl bg-slate-200/40 dark:bg-slate-800/40 mb-8">
            <div class="flex-shrink-0">
              {% if user.userprofile.avatar %}
                <img src="{{ user.userprofile.avatar.url }}" 
                     alt="{{ user.username }}" 
                     class="w-24 h-24 rounded-full mb-3">
              {% else %}
                <img src="{% static 'images/hippo.png' %}" 
                     alt="{{ user.username }}" 
                     class="w-24 h-24 rounded-full mb-3">
              {% endif %}
            </div>

            <div class="flex-1 text-center sm:text-left">
              <h2 class="text-2xl font-bold text-slate-900 dark:text-white">{{ user.get_full_name|default:user.username }}</h2>
              <p class="text-slate-600 dark:text-slate-400">{{ user.email }}</p>
            </div>

            <a href="{% url 'settings' %}" 
               class="w-full sm:w-auto flex-shrink-0 h-10 px-6 bg-primary text-white rounded-lg text-sm font-bold shadow-lg hover:bg-primary/90 transition-all">
              Edit Profile
            </a>
          </div>

          <!-- Quiz Statistics -->
          <div class="mb-8">
            <h2 class="text-xl font-bold text-slate-900 dark:text-white mb-4">Quiz Statistics</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
              <div class="p-6 rounded-xl bg-slate-200/40 dark:bg-slate-800/40 text-center">
                <p class="text-sm text-slate-500">Quizzes Created</p>
                <p class="text-3xl font-bold text-slate-900 dark:text-white mt-1">{{ quizzes_created|default:"0" }}</p>
              </div>
              <div class="p-6 rounded-xl bg-slate-200/40 dark:bg-slate-800/40 text-center">
                <p class="text-sm text-slate-500">Quizzes Completed</p>
                <p class="text-3xl font-bold text-slate-900 dark:text-white mt-1">{{ quizzes_completed|default:"0" }}</p>
              </div>
              <div class="p-6 rounded-xl bg-slate-200/40 dark:bg-slate-800/40 text-center">
                <p class="text-sm text-slate-500">Best Score</p>
                <p class="text-3xl font-bold text-slate-900 dark:text-white mt-1">{{ best_score|default:"0%" }}</p>
              </div>
            </div>
          </div>

          <!-- Servers Section -->
          <div class="mb-8">
            <h2 class="text-xl font-bold text-slate-900 dark:text-white mb-4">Your Servers</h2>

            {% if servers %}
              <div class="divide-y divide-slate-200/80 dark:divide-slate-800/80 rounded-xl overflow-hidden bg-slate-200/40 dark:bg-slate-800/40">
                {% for server in servers %}
                  <div class="flex flex-col sm:flex-row sm:items-center justify-between p-4 gap-4">
                    <div>
                      <p class="font-medium text-slate-800 dark:text-slate-200 text-lg">{{ server.name }}</p>
                      <p class="text-sm text-slate-600 dark:text-slate-400">{{ server.description|default:"No description provided." }}</p>
                      <p class="text-xs text-slate-500 mt-1">Code: {{ server.code }}</p>
                    </div>

                    <div class="flex gap-2">
                      <button onclick="openModal('membersModal-{{ server.id }}')" 
                              class="h-8 px-4 text-sm font-bold rounded-lg bg-blue-500/10 text-blue-500 hover:bg-blue-500/20 transition-colors">
                        Members
                      </button>

                      <button onclick="openModal('resultsModal-{{ server.id }}')" 
                              class="h-8 px-4 text-sm font-bold rounded-lg bg-green-500/10 text-green-500 hover:bg-green-500/20 transition-colors">
                        Results
                      </button>

                      <a href="{% url 'delete_server' server.id %}"
                         class="h-8 px-4 text-sm font-bold rounded-lg bg-red-500/10 text-red-500 hover:bg-red-500/20 transition-colors">
                        Delete
                      </a>
                    </div>
                  </div>

                  <!-- Members Modal -->
                  <div id="membersModal-{{ server.id }}" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-900 rounded-lg shadow-lg w-11/12 max-w-md p-6 relative">
                      <button onclick="closeModal('membersModal-{{ server.id }}')" 
                              class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                        ✖
                      </button>
                      <h3 class="text-xl font-semibold text-slate-900 dark:text-white mb-4">Members of {{ server.name }}</h3>

                      {% if server.members.exists %}
                        <ul class="space-y-2 max-h-64 overflow-y-auto">
                          {% for member in server.members.all %}
                            <li class="p-2 rounded-md bg-slate-100 dark:bg-slate-800">
                              {{ member.username }}
                            </li>
                          {% endfor %}
                        </ul>
                      {% else %}
                        <p class="text-slate-500 text-sm">No members in this server.</p>
                      {% endif %}
                    </div>
                  </div>

                  <!-- Results Modal -->
                  <div id="resultsModal-{{ server.id }}" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-slate-900 rounded-lg shadow-lg w-11/12 max-w-3xl p-6 relative">
                      <button onclick="closeModal('resultsModal-{{ server.id }}')" 
                              class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                        ✖
                      </button>
                      <h3 class="text-xl font-semibold text-slate-900 dark:text-white mb-4">Quiz Results for {{ server.name }}</h3>

                      {% with member_attempts=attempts|dictsort:"user.username" %}
                        {% if attempts %}
                          <table class="w-full border border-slate-300 dark:border-slate-700 rounded-lg">
                            <thead class="bg-slate-100 dark:bg-slate-800">
                              <tr>
                                <th class="py-2 px-4 text-left">Username</th>
                                <th class="py-2 px-4 text-left">Quiz</th>
                                <th class="py-2 px-4 text-left">Score</th>
                                <th class="py-2 px-4 text-left">Date</th>
                              </tr>
                            </thead>
                            <tbody>
                              {% for attempt in attempts %}
                                {% if attempt.user in server.members.all %}
                                  <tr class="border-t border-slate-200 dark:border-slate-700">
                                    <td class="py-2 px-4">{{ attempt.user.username }}</td>
                                    <td class="py-2 px-4">{{ attempt.quiz.topic }}</td>
                                    <td class="py-2 px-4">{{ attempt.score }}</td>
                                    <td class="py-2 px-4">{{ attempt.created_at|date:"M d, Y H:i" }}</td>
                                  </tr>
                                {% endif %}
                              {% empty %}
                                <tr><td colspan="4" class="py-3 text-center text-slate-500">No quiz attempts found.</td></tr>
                              {% endfor %}
                            </tbody>
                          </table>
                        {% else %}
                          <p class="text-slate-500 text-sm">No quiz results yet for this server.</p>
                        {% endif %}
                      {% endwith %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-slate-500 text-center py-6">You haven’t created any servers yet.</p>
            {% endif %}
          </div>

          <!-- Logout -->
          <div class="mt-8 flex justify-start">
            <form method="post" action="{% url 'logout' %}">
              {% csrf_token %}
              <button type="submit" 
                      class="h-10 px-6 text-sm font-bold rounded-lg bg-red-500/10 dark:bg-red-500/20 text-red-500 hover:bg-red-500/20 dark:hover:bg-red-500/30 transition-colors">
                Log Out
              </button>
            </form>
          </div>

        </div>
      </div>
    </div>
  </main>
</div>

<!-- Modal Script -->
<script>
  function openModal(id) {
    document.getElementById(id).classList.remove('hidden');
  }
  function closeModal(id) {
    document.getElementById(id).classList.add('hidden');
  }
</script>
{% endblock %}
